# 缓存

> 缓存是银弹吗?

All problems in computer science can be solved by another level of indirection.

### 缓存无处不在

- 网络中的缓存
- 应用缓存
- 数据库缓存
- 计算机中的缓存

## 缓存置换算法

## 缓存的一致性

## 缓存的问题

### 缓存雪崩

缓存雪崩是指在设置缓存时采用了相同的过期时间，导致缓存在某一时刻同时失效。
请求全部转发到数据库，导致对数据库、CPU 和内存造成巨大压力，严重的会造成数据库宕机。从而形成一系列连锁反应，造成整个系统崩溃。

#### 解决方案

- 在原有的失效时间基础上增加一个随机值，比如 1-5 分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。
- 用加锁或者队列的方式保证缓存的单线程（进程）写，从而避免失效时大量的并发请求落到底层存储系统上。

### 缓存穿透

缓存穿透是指查询一个一定不存在的数据，由于缓存是不命中时被动写的，并且出于容错考虑，如果从存储层查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。
如果有人利用不存在的 key 频繁攻击应用，这就是漏洞。

#### 解决方案

- 如果一个查询返回的数据为空（不管是数据不存在，还是系统故障），仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟。
- 布隆过滤器，提前判断数据是否存在。

### 缓存击穿

如果缓存中某些 key 可能在某些时间点被超高并发地访问，是一种非常“热点”的数据，那么可能在过期的时候有大量并发的请求进来打垮数据库。
缓存击穿和缓存雪崩的区别在于这里针对某一 key 缓存，前者则是很多 key。

#### 解决方案

- 使用互斥锁（mutex key）
- 不设置物理的过期时间，但为每个 value 设置一个逻辑过期时间，当发现超过逻辑过期时间后，会使用单独的线程去构建缓存。

## 参考

- [非功能性约束之性能（1）-性能银弹：缓存](https://buzzly.net/p/mRShSB6q/)
